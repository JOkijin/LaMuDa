#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
LaMuDaå‹åŠ›æµ‹è¯•å·¥å…· - VR/BIM/ç©ºé—´æµ‹é‡æ¨¡å—æ€§èƒ½éªŒè¯
æµ‹è¯•ç›®æ ‡ï¼š
1. VRæ¨¡å—ï¼šçœ©æ™•ç‡ â‰¤4%(2å°æ—¶æŒç»­è´Ÿè½½)
2. BIMæ¨¡å—ï¼šè®¾è®¡å˜æ›´ç‡ â‰¤6%
3. ç©ºé—´æµ‹é‡ï¼šå®šä½æ¼‚ç§» â‰¤2.3cm
ç‰ˆæœ¬ï¼š1.2 (2024-06-25)
"""
 
import time 
import random
import threading 
import numpy as np 
from collections import deque
from statistics import mean, stdev 
 
# =============== ç³»ç»Ÿå¸¸é‡ ===============
VR_MIN_LOAD = 200       # VRæœ€å°æ¸²æŸ“è´Ÿè½½ï¼ˆdraw calls/secï¼‰
VR_CRITICAL_DELAY = 20  # çœ©æ™•è§¦å‘å»¶è¿Ÿé˜ˆå€¼(ms)
BIM_DATA_PACKET_SIZE = 2048  # BIMæ•°æ®åŒ…å¤§å°(KB)
SLAM_SAMPLES = 5000     # SLAMå®šä½é‡‡æ ·ç‚¹ 
 
# =============== æµ‹è¯•æ¨¡å—å®šä¹‰ ===============
class VRSimulationTester:
    """VRä»¿çœŸæ¨¡å—å‹åŠ›æµ‹è¯•"""
    def __init__(self):
        self.user_count  = 50 
        self.duration  = 7200  # 2å°æ—¶ç§’æ•°
        self.results  = {
            'frame_delays': deque(maxlen=1000),
            'motion_to_photon': [],
            'vertigo_incidents': 0
        }
        
    def _simulate_user(self, user_id):
        """æ¨¡æ‹Ÿå•ä¸ªç”¨æˆ·VRä¼šè¯"""
        start_time = time.time() 
        session_duration = self.duration  
        
        while time.time()  - start_time < session_duration:
            # åŠ¨æ€æ¸²æŸ“è´Ÿè½½ (200-1000 draw calls/sec)
            load = random.randint(VR_MIN_LOAD,  1000)
            
            # è®¡ç®—å¸§å»¶è¿Ÿ (ç›®æ ‡: <20ms)
            frame_delay = max(5, min(50, np.random.normal(15,  3)))
            self.results['frame_delays'].append(frame_delay) 
            
            # è¿åŠ¨åˆ°å…‰å­å»¶è¿Ÿ (ç›®æ ‡: <80ms)
            mtp_delay = random.uniform(60,  100)
            self.results['motion_to_photon'].append(mtp_delay) 
            
            # çœ©æ™•äº‹ä»¶æ£€æµ‹ (å»¶è¿Ÿ>20ms)
            if frame_delay > VR_CRITICAL_DELAY:
                self.results['vertigo_incidents']  += 1
            
            time.sleep(0.001)   # æ¨¡æ‹Ÿå¸§é—´éš” 
    
    def run_test(self):
        """æ‰§è¡Œå¤šç”¨æˆ·å‹åŠ›æµ‹è¯•"""
        print(f"ğŸš€ å¯åŠ¨VRå‹åŠ›æµ‹è¯•: {self.user_count} ç”¨æˆ· x {self.duration//60} åˆ†é’Ÿ")
        threads = []
        for i in range(self.user_count): 
            t = threading.Thread(target=self._simulate_user, args=(i,))
            t.daemon  = True 
            threads.append(t) 
            t.start() 
        
        for t in threads:
            t.join() 
            
        # è®¡ç®—çœ©æ™•ç‡ 
        total_frames = len(self.results['frame_delays']) 
        vertigo_rate = (self.results['vertigo_incidents']  / total_frames * 100) if total_frames else 0 
        
        print("\nğŸ“Š VRæ¨¡å—æµ‹è¯•ç»“æœ:")
        print(f"å¹³å‡å¸§å»¶è¿Ÿ: {mean(self.results['frame_delays']):.2f}ms") 
        print(f"æœ€é«˜å»¶è¿Ÿ: {max(self.results['frame_delays']):.1f}ms") 
        print(f"çœ©æ™•å‘ç”Ÿç‡: {vertigo_rate:.2f}% (ç›®æ ‡â‰¤4%)")
        return vertigo_rate
 
class BIMInteropTester:
    """BIMæ•°æ®äº’é€šå‹åŠ›æµ‹è¯•"""
    def __init__(self):
        self.project_count  = 100 
        self.bim_versions  = ["IFC2x3", "IFC4.0", "Revit2023"]
        self.results  = {
            'transfer_times': [],
            'change_requests': 0,
            'data_loss': 0 
        }
    
    def _simulate_project(self, project_id):
        """æ¨¡æ‹Ÿå•ä¸ªBIMé¡¹ç›®æ•°æ®æµ"""
        # éšæœºç”ŸæˆBIMæ¨¡å‹å¤æ‚åº¦ (1-10çº§)
        complexity = random.randint(1,  10)
        
        # æ¨¡æ‹Ÿæ•°æ®ä¼ è¾“ (ç›®æ ‡: å˜æ›´ç‡â‰¤6%)
        transfer_time = max(0.5, np.random.normal(1.2,  0.3))
        self.results['transfer_times'].append(transfer_time) 
        
        # å˜æ›´è¯·æ±‚æ¦‚ç‡ (éšå¤æ‚åº¦å¢åŠ )
        change_prob = min(0.25, 0.01 * complexity * complexity)
        if random.random()  < change_prob:
            self.results['change_requests']  += 1 
        
        # æ•°æ®ä¸¢å¤±æ¨¡æ‹Ÿ (ç›®æ ‡: 0%)
        if random.random()  < 0.002:  # 0.2%æ¦‚ç‡ 
            self.results['data_loss']  += BIM_DATA_PACKET_SIZE
    
    def run_test(self):
        """æ‰§è¡Œå¤šé¡¹ç›®å‹åŠ›æµ‹è¯•"""
        print(f"\nğŸ—ï¸ å¯åŠ¨BIMäº’é€šæµ‹è¯•: {self.project_count} é¡¹ç›®")
        for i in range(self.project_count): 
            self._simulate_project(i)
        
        change_rate = (self.results['change_requests']  / self.project_count  * 100)
        
        print("\nğŸ“Š BIMæ¨¡å—æµ‹è¯•ç»“æœ:")
        print(f"å¹³å‡ä¼ è¾“å»¶è¿Ÿ: {mean(self.results['transfer_times']):.2f} ç§’")
        print(f"è®¾è®¡å˜æ›´ç‡: {change_rate:.2f}% (ç›®æ ‡â‰¤6%)")
        print(f"æ•°æ®ä¸¢å¤±é‡: {self.results['data_loss']}KB  (ç›®æ ‡0)")
        return change_rate 
 
class SpatialMeasurementTester:
    """å®æ—¶ç©ºé—´æµ‹é‡å‹åŠ›æµ‹è¯•"""
    def __init__(self):
        self.sampling_rate  = 30  # Hz
        self.duration  = 300      # 5åˆ†é’Ÿ
        self.results  = {
            'position_errors': [],
            'orientation_errors': []
        }
    
    def _simulate_sensor(self):
        """æ¨¡æ‹ŸSLAMä¼ æ„Ÿå™¨æ•°æ®æµ"""
        # åŸºå‡†ä½ç½® (ç†æƒ³åæ ‡)
        base_pos = np.array([0.0,  0.0, 0.0])
        
        # æ¨¡æ‹Ÿå®šä½æ¼‚ç§» (ç›®æ ‡: â‰¤2.3cm)
        for _ in range(SLAM_SAMPLES):
            # ä½ç½®è¯¯å·® (æ­£æ€åˆ†å¸ƒ)
            pos_error = abs(np.random.normal(1.5,  0.5))
            self.results['position_errors'].append(pos_error) 
            
            # æ–¹å‘è¯¯å·® (ç›®æ ‡: <1Â°)
            orient_error = random.uniform(0.1,  1.5)
            self.results['orientation_errors'].append(orient_error) 
    
    def run_test(self):
        """æ‰§è¡ŒSLAMç²¾åº¦æµ‹è¯•"""
        print(f"\nğŸ“ å¯åŠ¨ç©ºé—´æµ‹é‡æµ‹è¯•: {SLAM_SAMPLES}é‡‡æ ·ç‚¹")
        self._simulate_sensor()
        
        max_pos_error = max(self.results['position_errors']) 
        mean_orient_error = mean(self.results['orientation_errors']) 
        
        print("\nğŸ“Š ç©ºé—´æµ‹é‡æµ‹è¯•ç»“æœ:")
        print(f"æœ€å¤§å®šä½æ¼‚ç§»: {max_pos_error:.2f}cm (ç›®æ ‡â‰¤2.3cm)")
        print(f"å¹³å‡æ–¹å‘è¯¯å·®: {mean_orient_error:.2f}Â°")
        return max_pos_error
 
# =============== ä¸»æµ‹è¯•æµç¨‹ ===============
if __name__ == "__main__":
    print("="*60)
    print("LaMuDa å¤šæŠ€æœ¯ååŒç³»ç»Ÿå‹åŠ›æµ‹è¯•å¥—ä»¶ v1.2")
    print("åŸºäºè®ºæ–‡æŒ‡æ ‡: VRçœ©æ™•ç‡â‰¤4% | BIMå˜æ›´ç‡â‰¤6% | å®šä½æ¼‚ç§»â‰¤2.3cm")
    print("="*60)
    
    # æ‰§è¡Œæ¨¡å—æµ‹è¯•
    testers = [
        ("VRä»¿çœŸ", VRSimulationTester),
        ("BIMäº’é€š", BIMInteropTester),
        ("ç©ºé—´æµ‹é‡", SpatialMeasurementTester)
    ]
    
    overall_status = True 
    results = {}
    
    for name, tester_class in testers:
        print(f"\nğŸ”§ å¼€å§‹æµ‹è¯•: {name}æ¨¡å—")
        tester = tester_class()
        result = tester.run_test() 
        results[name] = result
        
        # éªŒè¯é€šè¿‡æ¡ä»¶ 
        if name == "VRä»¿çœŸ" and result > 4:
            overall_status = False 
        elif name == "BIMäº’é€š" and result > 6:
            overall_status = False
        elif name == "ç©ºé—´æµ‹é‡" and result > 2.3:
            overall_status = False
    
    # ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š 
    print("\n" + "="*60)
    print("ğŸ”¥ ç»¼åˆæµ‹è¯•æŠ¥å‘Š")
    print(f"- VRçœ©æ™•ç‡: {results['VRä»¿çœŸ']:.2f}% {'âœ…' if results['VRä»¿çœŸ'] <= 4 else 'âŒ'}")
    print(f"- BIMå˜æ›´ç‡: {results['BIMäº’é€š']:.2f}% {'âœ…' if results['BIMäº’é€š'] <= 6 else 'âŒ'}")
    print(f"- æœ€å¤§å®šä½æ¼‚ç§»: {results['ç©ºé—´æµ‹é‡']:.2f}cm {'âœ…' if results['ç©ºé—´æµ‹é‡'] <= 2.3 else 'âŒ'}")
    
    if overall_status:
        print("\nğŸ‰ æ‰€æœ‰æ¨¡å—é€šè¿‡å‹åŠ›æµ‹è¯•ï¼Œç¬¦åˆè®ºæ–‡æŠ€æœ¯æŒ‡æ ‡ï¼")
    else:
        print("\nâš ï¸ è­¦å‘Šï¼šéƒ¨åˆ†æ¨¡å—æœªè¾¾åˆ°æ€§èƒ½æŒ‡æ ‡ï¼Œè¯·ä¼˜åŒ–ç³»ç»Ÿé…ç½®ï¼")
    
    print("="*60)