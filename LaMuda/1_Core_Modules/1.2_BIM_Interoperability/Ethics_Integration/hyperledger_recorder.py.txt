#!/usr/bin/env python3 
# hyperledger_recorder.py  
# åŸºäºHyperledger Fabricçš„è®¾è®¡ç‰ˆæƒå­˜è¯ç³»ç»Ÿ 
# å®ç°è®ºæ–‡ä¸­"ç§’çº§ç¡®æƒ"ä¸"3åˆ†é’Ÿè¿½æº¯å“åº”"çš„æ ¸å¿ƒè¦æ±‚ 
 
from fabric_sdk_py import Gateway, Contract, Network 
from hashlib import sha3_256 
import json 
import time 
import uuid 
 
class DesignCopyrightRecorder:
    def __init__(self):
        # è®ºæ–‡ä¸­è¦æ±‚çš„è®¾è®¡ç‰ˆæƒå­˜è¯å¹³å°åˆå§‹åŒ– 
        self.gateway  = Gateway()
        self._connect_fabric()
        self.contract  = self._get_contract()
        self.ipfs_nodes  = ["https://ipfs.node1.lamuda",  "https://ipfs.node2.lamuda"] 
        
    def _connect_fabric(self):
        """è¿æ¥Hyperledger Fabricç½‘ç»œï¼ˆè®ºæ–‡4.1èŠ‚ä¼¦ç†æ²»ç†æ–¹æ¡ˆï¼‰"""
        try:
            # ç¬¦åˆè®ºæ–‡è¦æ±‚çš„åŠ å¯†é…ç½® 
            crypto_config = {
                'crypto_suite': 'ECDSAP256',
                'hash_algorithm': 'SHA3-256',
                'signature_scheme': 'ECDSA'
            }
            self.gateway.connect( 
                endpoint='grpcs://fabric-network.lamuda-system:7054', 
                identity='admin@lamuda.org', 
                crypto_config=crypto_config 
            )
            print("âœ… å·²è¿æ¥åˆ°Hyperledger Fabricç½‘ç»œ")
        except Exception as e:
            print(f"âŒ åŒºå—é“¾è¿æ¥å¤±è´¥: {str(e)}")
            raise ConnectionError("è¯·æ£€æŸ¥ç½‘ç»œé…ç½®")
 
    def _get_contract(self):
        """è·å–æ™ºèƒ½åˆçº¦æ¥å£ï¼ˆè®ºæ–‡6.1èŠ‚åŒºå—é“¾å­˜è¯ï¼‰"""
        network = self.gateway.get_network('lamudachannel') 
        return network.get_contract('designCopyrightContract') 
 
    def _ipfs_upload(self, design_data):
        """ä¸Šä¼ è®¾è®¡æ–‡ä»¶åˆ°IPFSé›†ç¾¤ï¼ˆç¬¦åˆè®ºæ–‡è¦æ±‚çš„åˆ†å¸ƒå¼å­˜å‚¨ï¼‰"""
        # è®ºæ–‡4.4èŠ‚æåˆ°çš„æ•°æ®å­˜å‚¨æ–¹æ¡ˆ 
        content_hash = sha3_256(design_data).hexdigest()
        # æ¨¡æ‹ŸIPFSä¸Šä¼ ï¼ˆå®é™…å®ç°éœ€ç”¨ipfshttpclientï¼‰
        print(f"ğŸ“¤ è®¾è®¡æ–‡ä»¶å·²ä¸Šä¼ è‡³IPFSï¼Œå“ˆå¸Œå€¼: {content_hash[:12]}...")
        return f"ipfs://{content_hash}"
 
    def _generate_copyright_id(self, designer_id):
        """ç”Ÿæˆå”¯ä¸€ç‰ˆæƒIDï¼ˆè®ºæ–‡6.1èŠ‚ç¡®æƒæœºåˆ¶ï¼‰"""
        # æ ¼å¼: LMD-æ—¶é—´æˆ³-è®¾è®¡å¸ˆIDå“ˆå¸Œ 
        timestamp = int(time.time()  * 1000)
        unique_suffix = sha3_256(f"{designer_id}{uuid.uuid4()}".encode()).hexdigest()[:8] 
        return f"LMD-{timestamp}-{unique_suffix.upper()}" 
 
    def register_design(self, designer_id, design_data, metadata):
        """
        è®¾è®¡ç‰ˆæƒæ³¨å†Œï¼ˆå®ç°è®ºæ–‡è¦æ±‚çš„ç§’çº§ç¡®æƒï¼‰
        :param designer_id: è®¾è®¡å¸ˆèº«ä»½ID (RFC-4514æ ¼å¼)
        :param design_data: è®¾è®¡æ–‡ä»¶äºŒè¿›åˆ¶å†…å®¹ 
        :param metadata: è®¾è®¡å…ƒæ•°æ® (JSONæ ¼å¼)
        :return: ç‰ˆæƒIDå’Œäº¤æ˜“æ”¶æ® 
        """
        # æ­¥éª¤1: IPFSå­˜å‚¨ï¼ˆè®ºæ–‡4.4èŠ‚ï¼‰
        ipfs_uri = self._ipfs_upload(design_data)
        
        # æ­¥éª¤2: ç”Ÿæˆå”¯ä¸€ç‰ˆæƒIDï¼ˆè®ºæ–‡6.1èŠ‚ï¼‰
        copyright_id = self._generate_copyright_id(designer_id)
        
        # æ­¥éª¤3: æ„å»ºåŒºå—é“¾äº¤æ˜“ï¼ˆè®ºæ–‡å›¾1-7ç‰ˆæƒå­˜è¯æµç¨‹ï¼‰
        tx_data = {
            'copyright_id': copyright_id,
            'designer': designer_id,
            'ipfs_uri': ipfs_uri,
            'metadata': metadata,
            'timestamp': int(time.time()), 
            'derivative_index': {}  # åˆå§‹åŒ–è¡ç”Ÿå“ç´¢å¼• 
        }
        
        # æ­¥éª¤4: æäº¤äº¤æ˜“ï¼ˆå®ç°ç§’çº§ç¡®æƒï¼‰
        try:
            # æ™ºèƒ½åˆçº¦è°ƒç”¨: registerDesign(copyrightId, metadata, ipfsURI)
            submission = self.contract.submit_transaction( 
                'registerDesign', 
                copyright_id, 
                json.dumps(metadata),  
                ipfs_uri 
            )
            
            # è§£æäº¤æ˜“å“åº”ï¼ˆç¬¦åˆè®ºæ–‡3.2èŠ‚éªŒè¯è¦æ±‚ï¼‰
            tx_receipt = json.loads(submission.decode()) 
            print(f"âœ… ç‰ˆæƒæ³¨å†ŒæˆåŠŸ | ID: {copyright_id} | åŒºå—: {tx_receipt['blockNumber']}")
            return {
                'copyright_id': copyright_id,
                'tx_receipt': tx_receipt,
                'ipfs_uri': ipfs_uri 
            }
            
        except Exception as e:
            print(f"âŒ ç‰ˆæƒæ³¨å†Œå¤±è´¥: {str(e)}")
            raise RuntimeError("åŒºå—é“¾äº¤æ˜“è¢«æ‹’ç»")
 
    def record_derivative(self, original_id, derivative_data, modifier_id):
        """
        è®°å½•è¡ç”Ÿå“è®¾è®¡ï¼ˆå®ç°è®ºæ–‡è¦æ±‚çš„3åˆ†é’Ÿè¿½æº¯ï¼‰
        :param original_id: åŸå§‹è®¾è®¡ç‰ˆæƒID 
        :param derivative_data: è¡ç”Ÿè®¾è®¡æ–‡ä»¶ 
        :param modifier_id: ä¿®æ”¹è€…èº«ä»½ID 
        :return: è¡ç”Ÿå“è®°å½•ID 
        """
        # æ­¥éª¤1: IPFSå­˜å‚¨è¡ç”Ÿç‰ˆæœ¬ 
        ipfs_uri = self._ipfs_upload(derivative_data)
        
        # æ­¥éª¤2: ç”Ÿæˆè¡ç”Ÿè®°å½•IDï¼ˆè®ºæ–‡6.1èŠ‚è¿½æº¯æœºåˆ¶ï¼‰
        der_id = f"{original_id}_DER_{int(time.time())}" 
        
        # æ­¥éª¤3: åœ¨åŒºå—é“¾æ·»åŠ è¡ç”Ÿè®°å½• 
        try:
            # åˆçº¦è°ƒç”¨: addDerivativeRecord(originalId, derId, modifier, ipfsURI)
            self.contract.submit_transaction( 
                'addDerivativeRecord',
                original_id,
                der_id,
                modifier_id,
                ipfs_uri 
            )
            
            # æ„å»ºå¿«é€Ÿç´¢å¼•ï¼ˆå®ç°3åˆ†é’Ÿå“åº”æ ¸å¿ƒï¼‰
            derivative_index = {
                der_id: {
                    'modifier': modifier_id,
                    'timestamp': int(time.time()), 
                    'ipfs_uri': ipfs_uri,
                    'original': original_id 
                }
            }
            
            # æ›´æ–°åŸå§‹è®¾è®¡çš„è¡ç”Ÿå“ç´¢å¼•ï¼ˆè®ºæ–‡å›¾1-7è¿½æº¯æµç¨‹ï¼‰
            self.contract.submit_transaction( 
                'updateDerivativeIndex',
                original_id,
                json.dumps(derivative_index) 
            )
            
            print(f"ğŸ”„ è¡ç”Ÿå“è®°å½•æˆåŠŸ | åŸå§‹ID: {original_id} | è¡ç”ŸID: {der_id}")
            return der_id 
            
        except Exception as e:
            print(f"âŒ è¡ç”Ÿå“è®°å½•å¤±è´¥: {str(e)}")
            raise RuntimeError("è¡ç”Ÿå“æ³¨å†Œå¼‚å¸¸")
 
    def verify_copyright(self, copyright_id):
        """ç‰ˆæƒéªŒè¯ï¼ˆè®ºæ–‡4.4èŠ‚éªŒè¯æœºåˆ¶ï¼‰"""
        try:
            # é“¾ä¸ŠæŸ¥è¯¢: verifyCopyright(copyrightId)
            result = self.contract.evaluate_transaction( 
                'verifyCopyright', 
                copyright_id 
            )
            return json.loads(result.decode()) 
        except Exception as e:
            print(f"âŒ éªŒè¯å¤±è´¥: {str(e)}")
            return {'status': 'INVALID', 'error': str(e)}
 
    def get_derivative_history(self, original_id):
        """è·å–è¡ç”Ÿå“ä¿®æ”¹å†å²ï¼ˆå®ç°è®ºæ–‡3åˆ†é’Ÿè¿½æº¯è¦æ±‚ï¼‰"""
        try:
            start_time = time.time() 
            
            # é“¾ä¸ŠæŸ¥è¯¢: getDerivativeIndex(originalId)
            result = self.contract.evaluate_transaction( 
                'getDerivativeIndex', 
                original_id 
            )
            
            history = json.loads(result.decode()) 
            elapsed = time.time()  - start_time 
            
            # è®°å½•å“åº”æ—¶é—´ï¼ˆè®ºæ–‡è¦æ±‚<3åˆ†é’Ÿï¼‰
            print(f"â±ï¸ å†å²è¿½æº¯å®Œæˆ | æ¡ç›®: {len(history)} | ç”¨æ—¶: {elapsed:.2f}s")
            return history 
            
        except Exception as e:
            print(f"âŒ å†å²æŸ¥è¯¢å¤±è´¥: {str(e)}")
            return {}
 
 
# ç¤ºä¾‹ä½¿ç”¨ï¼ˆç¬¦åˆè®ºæ–‡ä¸­æµ‹è¯•åœºæ™¯ï¼‰
if __name__ == "__main__":
    recorder = DesignCopyrightRecorder()
    
    # æ¨¡æ‹Ÿè®¾è®¡æ–‡ä»¶æ³¨å†Œ 
    design_data = b"VRå®¤å†…è®¾è®¡æ–¹æ¡ˆäºŒè¿›åˆ¶æ•°æ®..."
    metadata = {
        "designer": "uid=å¼ æ—º,ou=å¯¼å¸ˆ,dc=é²è¿…ç¾æœ¯å­¦é™¢",
        "project": "2030æ•°å­—å­ªç”Ÿå±•å…",
        "tech_stack": ["UE5", "AutoDesk", "HoloLens2"],
        "entropy_value": 0.83  # è®ºæ–‡ä¸­è®¾è®¡ç†µå€¼æŒ‡æ ‡ 
    }
    
    # ç‰ˆæƒæ³¨å†Œï¼ˆç§’çº§ç¡®æƒï¼‰
    reg_result = recorder.register_design( 
        designer_id="uid=é‡‘é«˜å³°,ou=ç¡•å£«ç”Ÿ,dc=é²è¿…ç¾æœ¯å­¦é™¢",
        design_data=design_data,
        metadata=metadata 
    )
    
    # è¡ç”Ÿå“è®°å½• 
    der_id = recorder.record_derivative( 
        original_id=reg_result['copyright_id'],
        derivative_data=b"ä¿®æ”¹ç‰ˆè®¾è®¡æ–¹æ¡ˆ...",
        modifier_id="uid=æè®¾è®¡å¸ˆ,ou=åˆä½œæ–¹,dc=åœŸå·´å…”"
    )
    
    # ç‰ˆæƒéªŒè¯ 
    verification = recorder.verify_copyright(reg_result['copyright_id']) 
    print(f"ğŸ›¡ï¸ ç‰ˆæƒéªŒè¯ç»“æœ: {verification['status']}")
    
    # è¿½æº¯å†å²ï¼ˆåº”<180ç§’ï¼‰
    history = recorder.get_derivative_history(reg_result['copyright_id']) 
    print(f"ğŸ“œ ä¿®æ”¹å†å²è®°å½•: {list(history.keys())}") 